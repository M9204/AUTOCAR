<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AUTOCAR control</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; max-width:720px; margin:40px auto; }
    .status { display:flex; align-items:center; gap:10px; }
    .led { width:14px; height:14px; border-radius:50%; background:#888; }
    .led.online { background:green; box-shadow:0 0 6px rgba(0,200,0,0.6); }
    .led.offline { background:#888; }
    button { padding:10px 16px; margin:6px; font-size:16px; }
    .log { background:#f5f5f5; padding:10px; margin-top:12px; height:160px; overflow:auto; border:1px solid #ddd; }
    .small { font-size:13px; color:#666; }
  </style>
</head>
<body>
  <h1>AUTOCAR — web control</h1>

  <div class="status">
    <div id="led" class="led offline"></div>
    <div>
      Device status: <strong id="deviceStatus">unknown</strong><br/>
      Broker connection: <strong id="brokerStatus">disconnected</strong>
    </div>
  </div>

  <div style="margin-top:12px;">
    <button id="btnOn">Trigger ON (22→25, 1s each)</button>
    <button id="btnOff">Trigger OFF (25→22, 500ms each)</button>
  </div>

  <div class="small" style="margin-top:10px;">
    Topic (commands) = <code>autocar/commands</code><br/>
    Status topic = <code>autocar/status</code>
  </div>

  <div class="log" id="log"></div>

  <!-- mqtt.js from CDN -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const logEl = document.getElementById('log');
    function log(s){ logEl.innerHTML = (new Date().toLocaleTimeString()) + ' — ' + s + '<br/>' + logEl.innerHTML; }

    // Broker info:
    // Use secure websocket (wss) so page works when served over HTTPS (GitHub Pages).
    const brokerUrl = 'wss://broker.hivemq.com:8884/mqtt'; // secure websockets
    const options = {
      keepalive: 30,
      reconnectPeriod: 4000,
      clientId: 'autocar-web-' + Math.random().toString(16).substr(2,8),
      clean: true
    };

    const topicCmd = 'autocar/commands';
    const topicStat = 'autocar/status';
    let lastStatusTs = 0;

    const client = mqtt.connect(brokerUrl, options);

    client.on('connect', function () {
      document.getElementById('brokerStatus').innerText = 'connected';
      log('Connected to broker');
      client.subscribe(topicStat, function(err){
        log('Subscribed to ' + topicStat + (err ? ' (err)' : ''));
      });
      // request a ping to provoke the device to respond if it's listening
      client.publish(topicCmd, 'PING');
    });

    client.on('reconnect', function(){ document.getElementById('brokerStatus').innerText='reconnecting'; log('Reconnecting...'); });
    client.on('close', function(){ document.getElementById('brokerStatus').innerText='disconnected'; log('Disconnected'); setDeviceOffline(); });
    client.on('error', function(err){ document.getElementById('brokerStatus').innerText='error'; log('Broker error: ' + err); });

    client.on('message', function(topic, message) {
      const msg = message.toString();
      log('Recv ' + topic + ': ' + msg);
      if (topic === topicStat) {
        // update device online indicator
        lastStatusTs = Date.now();
        setDeviceOnline();
      }
    });

    // Buttons
    document.getElementById('btnOn').addEventListener('click', function(){
      client.publish(topicCmd, 'TRIG_ON');
      log('Sent TRIG_ON');
    });
    document.getElementById('btnOff').addEventListener('click', function(){
      client.publish(topicCmd, 'TRIG_OFF');
      log('Sent TRIG_OFF');
    });

    function setDeviceOnline(){
      document.getElementById('deviceStatus').innerText = 'online (updated ' + new Date(lastStatusTs).toLocaleTimeString() + ')';
      const led = document.getElementById('led');
      led.classList.remove('offline'); led.classList.add('online');
    }
    function setDeviceOffline(){
      document.getElementById('deviceStatus').innerText = 'offline';
      const led = document.getElementById('led');
      led.classList.remove('online'); led.classList.add('offline');
    }

    // check for staleness: if no heartbeat in 40s mark offline
    setInterval(function(){
      if (lastStatusTs === 0) { setDeviceOffline(); return; }
      if (Date.now() - lastStatusTs > 40000) setDeviceOffline();
    }, 5000);

  </script>
</body>
</html>
