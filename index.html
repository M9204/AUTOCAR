<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 Car Control</title>

  <style>
    :root { font-family: system-ui, -apple-system, Roboto, sans-serif; }
    body { margin:0; background:#f5f7fb; color:#111; }
    .card {
      max-width: 480px; margin:auto; padding:16px;
      background:#fff; border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
    }
    h1 { font-size:20px; margin:0 0 8px; text-align:center; }
    h3 { margin:8px 0; font-size:16px; }
    .section { margin:16px 0; }
    .statusline { display:flex; align-items:center; gap:8px; font-size:14px; }
    .dot { width:12px; height:12px; border-radius:50%; }
    .dot.on { background:#16a34a; }
    .dot.off { background:#bbb; }
    button {
      width:100%; padding:14px; margin:6px 0;
      border:none; border-radius:10px;
      font-size:16px; font-weight:500;
      cursor:pointer; transition:0.2s;
    }
    button:active { transform:scale(0.98); }
    .start { background:#16a34a; color:#fff; }
    .stop { background:#ef4444; color:#fff; }
    .relay-btn {
      background:#e5e7eb; color:#111;
    }
    .relay-btn.on { background:#0b74ff; color:#fff; }
    .field input {
      width:100%; padding:10px; margin:6px 0;
      border:1px solid #ccc; border-radius:8px;
      font-size:14px;
    }
    .log {
      height:150px; overflow:auto;
      background:#0b1220; color:#e6f2ff;
      padding:10px; border-radius:8px;
      font-family:monospace; font-size:12px;
    }
    footer { margin-top:12px; text-align:center; font-size:12px; color:#666; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸš— ESP32 Car Control</h1>

    <div class="section">
      <h3>Connection</h3>
      <div class="field"><input id="host" type="text" value="ddf927fd9af44789b245774345c7bf14.s1.eu.hivemq.cloud" /></div>
      <div class="field"><input id="wsport" type="text" value="8884" /></div>
      <div class="field"><input id="user" type="text" value="user9" /></div>
      <div class="field"><input id="pass" type="password" value="hknnQlRofqnyqj_aQxmeoJ6vPbvK-4fX" /></div>
      <button id="connectBtn">Connect</button>
      <div class="statusline"><div id="connDot" class="dot off"></div><span id="connState">Disconnected</span></div>
    </div>

    <div class="section">
      <h3>Car Start/Stop</h3>
      <button id="startBtn" class="start">START ðŸš€</button>
      <button id="stopBtn" class="stop">STOP â›”</button>
      <div class="statusline"><div id="carDot" class="dot off"></div><span id="carStatusText">Waiting...</span></div>
    </div>

    <div class="section">
      <h3>Relays</h3>
      <div id="relaysContainer"></div>
    </div>

    <div class="section">
      <h3>Log</h3>
      <div class="log" id="log"></div>
      <button id="clearLog">Clear Log</button>
    </div>

    <footer>ESP32 MQTT Web Control â€¢ Mobile Layout</footer>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const NUM_RELAYS = 4;
    let relayState = Array(NUM_RELAYS).fill(false);
    let client = null;

    const logEl = document.getElementById("log");
    function log(msg) {
      const t = new Date().toLocaleTimeString();
      logEl.innerText = `[${t}] ${msg}\n` + logEl.innerText;
    }

    function buildRelays() {
      const c = document.getElementById("relaysContainer");
      c.innerHTML = "";
      for (let i=0;i<NUM_RELAYS;i++) {
        const btn = document.createElement("button");
        btn.className = "relay-btn";
        btn.id = "relayBtn"+i;
        btn.innerText = `Relay ${i}: OFF`;
        btn.onclick = ()=> toggleRelay(i);
        c.appendChild(btn);
      }
    }
    buildRelays();

    function setRelayUi(i, on) {
      relayState[i]=on;
      const b=document.getElementById("relayBtn"+i);
      if(!b) return;
      b.classList.toggle("on",on);
      b.innerText=`Relay ${i}: ${on?"ON":"OFF"}`;
    }

    function toggleRelay(i) {
      if(!client||!client.connected) { log("Not connected"); return; }
      const newState=!relayState[i];
      client.publish(`car/relay/${i}`, newState?"on":"off");
      log(`OUT car/relay/${i} => ${newState?"on":"off"}`);
      setRelayUi(i,newState);
    }

    function handleIncoming(topic,msg){
      if(topic==="car/started"){
        const on=(msg==="true"||msg==="on");
        document.getElementById("carDot").className="dot "+(on?"on":"off");
        document.getElementById("carStatusText").innerText=on?"Car Started":"Car Stopped";
      }
      else if(topic.startsWith("car/relay/") && topic.endsWith("/state")){
        const idx=parseInt(topic.split("/")[2],10);
        setRelayUi(idx,msg==="on");
      }
    }

    document.getElementById("startBtn").onclick=()=>{
      client?.publish("car/start","start");
      log("OUT car/start => start");
    };
    document.getElementById("stopBtn").onclick=()=>{
      client?.publish("car/start","stop");
      log("OUT car/start => stop");
    };
    document.getElementById("clearLog").onclick=()=> logEl.innerText="";

    document.getElementById("connectBtn").onclick=()=>{
      if(client && client.connected){ client.end(true); return; }
      const host=document.getElementById("host").value.trim();
      const port=document.getElementById("wsport").value.trim();
      const user=document.getElementById("user").value.trim();
      const pass=document.getElementById("pass").value;
      const url=`wss://${host}:${port}/mqtt`;
      log(`Connecting to ${url}`);
      client=mqtt.connect(url,{username:user,password:pass,clientId:"web_"+Math.random().toString(16).slice(2)});
      client.on("connect",()=>{
        log("Connected âœ…");
        document.getElementById("connState").innerText="Connected";
        document.getElementById("connDot").className="dot on";
        client.subscribe("car/#");
      });
      client.on("message",(t,p)=>handleIncoming(t,p.toString()));
      client.on("close",()=>{
        document.getElementById("connState").innerText="Disconnected";
        document.getElementById("connDot").className="dot off";
        log("Disconnected");
      });
    };
  </script>
</body>
</html>
